name: ğŸ”„ CI - Trigger Tests

on:
  push:
    branches:
      - main
      - gateway
    tags-ignore:
      - '**'
  pull_request:
    branches:
      - main
      - gateway

permissions:
  contents: read

jobs:
  trigger-tests:
    name: ğŸš€ Trigger Tests in Private Test Environment
    runs-on: ubuntu-latest
    # ĞĞµ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ´Ğ»Ñ PR Ğ¸Ğ· Ñ„Ğ¾Ñ€ĞºĞ¾Ğ² (Ğ½ĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº secrets)
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository)

    steps:
      - name: ğŸ“‹ Show trigger info
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"

      - name: ğŸ”” Trigger test workflow in test repository
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.TEST_REPO_PAT }}
          repository: alexbic/zerotier-sidecar-test
          event-type: test-and-deploy
          client-payload: |
            {
              "source_repo": "${{ github.repository }}",
              "source_branch": "${{ github.ref_name }}",
              "source_sha": "${{ github.sha }}",
              "source_actor": "${{ github.actor }}",
              "source_event": "${{ github.event_name }}",
              "auto_deploy": "${{ github.event_name == 'push' && (github.ref_name == 'main' || github.ref_name == 'gateway') }}"
            }

      - name: ğŸ“Š Tests triggered
        run: |
          echo "âœ… Tests triggered in alexbic/zerotier-sidecar-test"
          echo ""
          echo "Monitor test progress:"
          echo "https://github.com/alexbic/zerotier-sidecar-test/actions"
          echo ""
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "âš ï¸  After tests pass, deploy workflow will be triggered"
            echo "   Deploy requires manual approval in 'production' environment"
            echo "   Review & approve at: https://github.com/${{ github.repository }}/actions"
          else
            echo "Auto-deploy: disabled (pull request)"
          fi

  # ĞĞ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ job Ğ´Ğ»Ñ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¾Ğº (Ğ±ĞµĞ· self-hosted runner)
  quick-checks:
    name: ğŸ” Quick Local Checks
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§© Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Check shell scripts syntax
        run: |
          echo "Checking bash syntax..."
          bash -n start-sidecar.sh
          echo "âœ… Syntax OK"

      - name: ğŸ“ Check Dockerfile syntax
        run: |
          echo "Checking Dockerfile..."
          docker --version || true
          echo "âœ… Dockerfile exists"
          [ -f Dockerfile ] && echo "âœ… Dockerfile found"

      - name: ğŸ“‹ Validate file structure
        run: |
          echo "Checking required files..."
          [ -f start-sidecar.sh ] && echo "âœ… start-sidecar.sh"
          [ -f Dockerfile ] && echo "âœ… Dockerfile"
          [ -f README.md ] && echo "âœ… README.md"
          echo "âœ… All required files present"
