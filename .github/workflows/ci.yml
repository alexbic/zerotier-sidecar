name: CI - Trigger Tests

on:
  push:
    branches:
      - main
    tags-ignore:
      - '**'

permissions:
  contents: read

jobs:
  trigger-tests:
    name: Trigger Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Check commit message
        id: check_commit
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Commit message: $COMMIT_MSG"

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∞—Ä–∫–µ—Ä—ã –ø—Ä–æ–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤
          if echo "$COMMIT_MSG" | grep -qiE '\[skip ci\]|\[skip-ci\]|\[deploy\]|\[no-test\]'; then
            echo "‚ö†Ô∏è Found skip marker in commit message - skipping tests"
            echo "skip_tests=true" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ No skip marker found - will run tests"
            echo "skip_tests=false" >> $GITHUB_OUTPUT
          fi

      - name: Show trigger info
        if: steps.check_commit.outputs.skip_tests == 'false'
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "Branch: ${{ github.ref_name }}"

      - name: Trigger test workflow
        if: steps.check_commit.outputs.skip_tests == 'false'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.TEST_REPO_PAT }}
          repository: alexbic/zerotier-sidecar-test
          event-type: test-and-deploy
          client-payload: |-
            {
              "source_repo": "${{ github.repository }}",
              "source_branch": "${{ github.ref_name }}",
              "source_sha": "${{ github.sha }}",
              "source_actor": "${{ github.actor }}",
              "source_event": "${{ github.event_name }}",
              "auto_deploy": "${{ github.event_name == 'push' && github.ref_name == 'main' }}"
            }

      - name: Tests triggered
        if: steps.check_commit.outputs.skip_tests == 'false'
        run: echo "‚úÖ Tests triggered in alexbic/zerotier-sidecar-test"

      - name: Tests skipped
        if: steps.check_commit.outputs.skip_tests == 'true'
        run: |
          echo "‚è≠Ô∏è Tests skipped due to commit message marker"
          echo ""
          echo "‚ÑπÔ∏è To skip automatic tests, use one of these markers in commit message:"
          echo "   - [skip ci]"
          echo "   - [skip-ci]"
          echo "   - [deploy]"
          echo "   - [no-test]"
          echo ""
          echo "üí° You can now manually trigger deploy workflow to push changes immediately"
