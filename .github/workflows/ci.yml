name: CI - Trigger Tests

on:
  push:
    branches:
      - main
    tags-ignore:
      - '**'

permissions:
  contents: read

jobs:
  trigger-tests:
    name: Trigger Tests
    runs-on: ubuntu-latest

    steps:
      - name: Show trigger info
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "Branch: ${{ github.ref_name }}"

      - name: Trigger test workflow
        env:
          GH_TOKEN: ${{ secrets.TEST_REPO_PAT }}
        run: |
          gh api repos/alexbic/zerotier-sidecar-test/dispatches \
            -X POST \
            -f event_type='test-and-deploy' \
            -f client_payload[source_repo]='${{ github.repository }}' \
            -f client_payload[source_branch]='${{ github.ref_name }}' \
            -f client_payload[source_sha]='${{ github.sha }}' \
            -f client_payload[source_actor]='${{ github.actor }}' \
            -f client_payload[source_event]='${{ github.event_name }}' \
            -f client_payload[auto_deploy]='${{ github.event_name == 'push' && github.ref_name == 'main' }}'

      - name: Tests triggered
        run: echo "âœ… Tests triggered in alexbic/zerotier-sidecar-test"
