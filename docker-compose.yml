# ZeroTier Sidecar - Docker Compose Configuration
#
# Comprehensive Logging System (v2.1.4+):
# - Service monitoring logs: /var/log/zerotier-sidecar/monitor.log
# - Connection tracking logs: /var/log/zerotier-sidecar/connections.log (full details)
# - Automatic log rotation (10MB limit, 5 historical files)
# - Container names displayed in logs instead of IP addresses
#
# Connection Logging via NFLOG + ulogd2:
# - Logs include: source IP, destination IP, ports, protocol
# - NEW connections tracked in real-time
# - Rate-limited to prevent log flooding (3/min per port)
# - Logs both INPUT (direct) and FORWARD (DNAT) traffic
#
# Debug Mode (NEW in v2.1.5+):
# - Set DEBUG_IPTABLES=true to enable comprehensive iptables logging
# - Logs ALL network activity: INPUT, OUTPUT, FORWARD, NAT, MANGLE
# - Useful for debugging network issues
# - WARNING: Generates A LOT of log entries!
# - Check logs with: docker exec zerotier-sidecar dmesg | grep 'DBG-'
#
# Connection Logs Console Output (NEW in v2.1.6+):
# - Set LOG_CONNECTIONS=true to output connection logs to Docker console
# - Shows new connections in real-time: docker logs -f zerotier-sidecar
# - Includes full connection details (SRC IP, DST IP, PORT, protocol)
# - Logs are still written to /var/log/zerotier-sidecar/connections.log
# - Useful for monitoring and debugging without exec into container
#
# Logs are accessible via:
#   docker exec zerotier-sidecar tail -f /var/log/zerotier-sidecar/monitor.log
#   docker exec zerotier-sidecar tail -f /var/log/zerotier-sidecar/connections.log
#
# Or mount the logs volume to persist logs on host:
#   /opt/zerotier-sidecar-logs:/var/log/zerotier-sidecar

version: "3.8"

services:
  zerotier-sidecar:
    image: alexbic/zerotier-sidecar:gateway
    container_name: zerotier-sidecar
    restart: unless-stopped
    privileged: true
    devices:
      - /dev/net/tun:/dev/net/tun
    volumes:
      - /opt/zerotier-sidecar:/var/lib/zerotier-one           # ZeroTier identity and configuration
      - /opt/zerotier-sidecar-logs:/var/log/zerotier-sidecar  # Monitoring logs (NEW in v2.1.4!)
    networks:
      - default
    env_file:
      - .env
    environment:
      # Default settings (can be overridden in .env file)
      - GATEWAY_MODE=${GATEWAY_MODE:-false}
      - ALLOWED_SOURCES=${ALLOWED_SOURCES:-any}
      - DEBUG_IPTABLES=${DEBUG_IPTABLES:-false}  # Enable comprehensive iptables logging
      - LOG_CONNECTIONS=${LOG_CONNECTIONS:-false}  # Output connection logs to console
    cap_add:
      - NET_ADMIN
      - SYS_ADMIN

networks:
  default:
    name: sidecar_net
